---
import { getCollection } from 'astro:content'
import Base from '../../layouts/Base.astro'
import PostCard from '../../components/PostCard.astro'
import Breadcrumb from '../../components/Breadcrumb.astro'
import { url } from '../../config'

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => !data.draft)
  const tags = [...new Set(posts.flatMap(p => p.data.tags))]

  return tags.map(tag => ({
    params: { tag },
    props: {
      tag,
      posts: posts
        .filter(p => p.data.tags.includes(tag))
        .sort((a, b) => b.data.pubDatetime.valueOf() - a.data.pubDatetime.valueOf())
    }
  }))
}

const { tag, posts } = Astro.props
---
<Base title={`Posts tagged #${tag}`}>
  <Breadcrumb items={[{ label: 'Tags', href: url('/tags') }, { label: `#${tag}` }]} />

  <h1 class="text-3xl font-bold mt-8 mb-8">
    Posts tagged <span class="text-accent">#{tag}</span>
  </h1>

  <p class="text-skin-muted mb-8">{posts.length} post{posts.length !== 1 ? 's' : ''}</p>

  <div class="space-y-6">
    {posts.map(post => (
      <PostCard
        slug={post.slug}
        title={post.data.title}
        pubDatetime={post.data.pubDatetime}
        description={post.data.description}
        tags={post.data.tags}
        body={post.body || ''}
        heroImage={post.data.heroImage}
      />
    ))}
  </div>
</Base>
